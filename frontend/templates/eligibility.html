<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Eligibility Checker</title>
    <link rel="stylesheet" href="el.css">
</head>
<body>
    <div class="container">
        <h2>Loan Eligibility Checker</h2>
        <form id="eligibilityForm" class="eligibility-form">
            <div class="form-group">
                <label for="no_of_dependents">Number of Dependents:</label>
                <input type="number" id="no_of_dependents" name="no_of_dependents" min="0" max="10" required>
            </div>
            <div class="form-group">
                <label for="education">Education:</label>
                <select id="education" name="education" required>
                    <option value="">Select</option>
                    <option value="1">Graduate</option>
                    <option value="0">Not Graduate</option>
                </select>
            </div>
            <div class="form-group">
                <label for="self_employed">Self Employed:</label>
                <select id="self_employed" name="self_employed" required>
                    <option value="">Select</option>
                    <option value="1">Yes</option>
                    <option value="0">No</option>
                </select>
            </div>
            <div class="form-group">
                <label for="income_annum">Annual Income (₹):</label>
                <input type="number" id="income_annum" name="income_annum" min="1" required>
            </div>
            <div class="form-group">
                <label for="loan_amount">Loan Amount (₹):</label>
                <input type="number" id="loan_amount" name="loan_amount" min="1" required>
            </div>
            <div class="form-group">
                <label for="loan_term">Loan Term (Years):</label>
                <input type="number" id="loan_term" name="loan_term" min="1" max="30" required>
            </div>
            <div class="form-group">
                <label for="cibil_score">CIBIL Score (300-900):</label>
                <input type="number" id="cibil_score" name="cibil_score" min="300" max="900" required>
            </div>
            <div class="form-group">
                <label for="residential_assets_value">Residential Assets Value (₹):</label>
                <input type="number" id="residential_assets_value" name="residential_assets_value" min="0" value="0" required>
            </div>
            <div class="form-group">
                <label for="commercial_assets_value">Commercial Assets Value (₹):</label>
                <input type="number" id="commercial_assets_value" name="commercial_assets_value" min="0" value="0" required>
            </div>
            <div class="form-group">
                <label for="luxury_assets_value">Luxury Assets Value (₹):</label>
                <input type="number" id="luxury_assets_value" name="luxury_assets_value" min="0" value="0" required>
            </div>
            <div class="form-group">
                <label for="bank_asset_value">Bank Asset Value (₹):</label>
                <input type="number" id="bank_asset_value" name="bank_asset_value" min="0" value="0" required>
            </div>
            <button type="submit">Check Eligibility</button>
        </form>
        <div id="loading" class="loading" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i> <span id="loadingText">Checking eligibility...</span>
        </div>
        <div id="result" class="result"></div>
    </div>
    
    <script>
        document.getElementById('eligibilityForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loadingDiv = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const resultDiv = document.getElementById('result');
            const submitButton = this.querySelector('button[type="submit"]');
            
            // Disable form and show loading
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';
            loadingDiv.style.display = 'block';
            resultDiv.style.display = 'none';

            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Ensure numerical fields are sent as numbers
            data.no_of_dependents = parseFloat(data.no_of_dependents);
            data.education = parseFloat(data.education);
            data.self_employed = parseFloat(data.self_employed);
            data.income_annum = parseFloat(data.income_annum);
            data.loan_amount = parseFloat(data.loan_amount);
            data.loan_term = parseFloat(data.loan_term);
            data.cibil_score = parseFloat(data.cibil_score);
            data.residential_assets_value = parseFloat(data.residential_assets_value);
            data.commercial_assets_value = parseFloat(data.commercial_assets_value);
            data.luxury_assets_value = parseFloat(data.luxury_assets_value);
            data.bank_asset_value = parseFloat(data.bank_asset_value);

            console.log('Sending data:', data);

            // Add timeout for requests
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Request timeout')), 30000)
            );

            try {
                loadingText.textContent = 'Connecting to server...';
                
                const fetchWithTimeout = async (url) => {
                    return Promise.race([
                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data)
                        }),
                        timeoutPromise
                    ]);
                };

                let response;
                let serverUsed = '';
                
                try {
                    loadingText.textContent = 'Connecting to production server...';
                    response = await fetchWithTimeout('https://loan-web-app-backend.onrender.com/check_eligibility');
                    serverUsed = 'production';
                } catch (prodError) {
                    console.log('Production server failed, trying local...', prodError.message);
                    try {
                        loadingText.textContent = 'Connecting to local server...';
                        response = await fetchWithTimeout('http://localhost:3000/check_eligibility');
                        serverUsed = 'localhost';
                    } catch (localError) {
                        console.log('Local server also failed:', localError.message);
                        throw new Error('Service temporarily unavailable. Please try again in a few minutes.');
                    }
                }

                loadingText.textContent = 'Processing your request...';

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error (${response.status}): ${errorText}`);
                }

                const result = await response.json();
                console.log('Response from', serverUsed, ':', result);
                
                loadingDiv.style.display = 'none';
                
                if (result.error) {
                    resultDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Error:</strong> ${result.error}
                        ${result.details ? `<br><small>${result.details}</small>` : ''}
                    `;
                    resultDiv.className = 'result failure';
                } else {
                    if (result.eligibility === 'Eligible') {
                        resultDiv.innerHTML = `
                            <i class="fas fa-check-circle"></i>
                            <strong>Congratulations!</strong><br>
                            You are eligible for the loan based on our ML model analysis.
                            <br><small>Confidence: ${result.confidence || 'High'}</small>
                            ${result.factors ? `<br><small>Key factors: CIBIL Score: ${result.factors.cibil_score}, Income-to-Loan Ratio: ${result.factors.income_to_loan_ratio}</small>` : ''}
                        `;
                        resultDiv.className = 'result success';
                    } else {
                        resultDiv.innerHTML = `
                            <i class="fas fa-times-circle"></i>
                            <strong>Sorry!</strong><br>
                            You are not eligible for the loan based on the provided information.
                            <br><small>Consider improving your credit score or adjusting loan amount.</small>
                            ${result.factors ? `<br><small>Your CIBIL Score: ${result.factors.cibil_score}, Income-to-Loan Ratio: ${result.factors.income_to_loan_ratio}</small>` : ''}
                        `;
                        resultDiv.className = 'result failure';
                    }
                }
                resultDiv.style.display = 'block';
                
            } catch (error) {
                loadingDiv.style.display = 'none';
                
                let errorMessage = 'Unknown error occurred';
                if (error.message.includes('timeout')) {
                    errorMessage = 'Request timed out. The server may be starting up or experiencing issues.';
                } else if (error.message.includes('unavailable')) {
                    errorMessage = 'Unable to connect to any server. Please check your internet connection.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Network error. Please check your internet connection and try again.';
                } else {
                    errorMessage = error.message;
                }
                
                resultDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Connection Error:</strong><br>
                    ${errorMessage}
                    <br><small>Please try again in a few moments.</small>
                `;
                resultDiv.className = 'result failure';
                resultDiv.style.display = 'block';
                console.error('Error:', error);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Check Eligibility';
                loadingText.textContent = 'Checking eligibility...';
            }
        });
    </script>
</body>
</html>